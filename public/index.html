<!doctype html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <title>Live Chat Monitor</title>
  <style>
    :root {
      --bg: #0f0f23;
      --fg: #e8e8e8;
      --card: #1a1a2e;
      --header-bg: #16213e;
      --name: #4fc3f7;
      --uid: #90a4ae;
      --orange: #ff9800;
      --border: #2d3748;
      --hover: #252545;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    html.light {
      --bg: #f5f7fa;
      --fg: #2d3748;
      --card: #ffffff;
      --header-bg: #ffffff;
      --name: #1976d2;
      --uid: #64748b;
      --border: #e2e8f0;
      --hover: #f1f5f9;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    html.light body {
      background: var(--bg);
      color: var(--fg);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--fg);
      overflow: hidden;
    }

    header {
      padding: 10px 20px;
      background: var(--header-bg);
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      box-shadow: 0 2px 8px var(--shadow);
      border-bottom: 1px solid var(--border);
    }

    #username {
      padding: 8px 14px;
      border: 2px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--fg);
      font-size: 14px;
      min-width: 220px;
      transition: border-color 0.3s;
    }

    #username:focus {
      outline: none;
      border-color: #2196f3;
    }

    button {
      border: none !important;
      padding: 5px 15px !important;
      color: white !important;
      border-radius: 6px !important;
      cursor: pointer !important;
      font-weight: 600 !important;
      font-size: 14px !important;
      transition: all 0.3s ease !important;
      box-shadow: 0 2px 4px var(--shadow) !important;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px var(--shadow) !important;
    }

    button:active {
      transform: translateY(0);
    }

    #connect {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    }

    #connect:hover {
      background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
    }

    #copyAll {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    }

    #copyAll:hover {
      background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
    }

    #clear {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }

    #clear:hover {
      background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
    }

    label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
    }

    input[type="checkbox"] {
      width: 44px;
      height: 22px;
      appearance: none;
      background: #cbd5e0;
      border-radius: 20px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }

    input[type="checkbox"]::before {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input[type="checkbox"]:checked {
      background: #2196f3;
    }

    input[type="checkbox"]:checked::before {
      transform: translateX(22px);
    }

    #currentLive {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--card);
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-left: auto;
    }

    #currentLive img {
      box-shadow: 0 2px 4px var(--shadow);
    }

    #currentLive b {
      color: var(--name);
    }

    #themeToggle {
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: background 0.3s;
    }

    #themeToggle:hover {
      background: var(--hover);
    }

    #themeToggle input[type="checkbox"] {
      display: none;
    }

    .theme-icon {
      width: 24px;
      height: 24px;
      fill: var(--fg);
    }

    .state-info {
      display: flex;
      gap: 1px;
      background: var(--border);
      border-bottom: 1px solid var(--border);
    }

    .state-section {
      flex: 0 0 62.05%;
      background: var(--card);
      padding: 8px 8px 8px 16px;
      font-size: 13px;
      line-height: 1.6;
    }

    .state-section pre {
      margin: 0;
      font-family: 'Courier New', monospace;
      color: var(--fg);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    #roomStats {
      color: var(--fg);
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    #roomStats>div {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    #roomStats strong {
      color: var(--fg);
      font-weight: 500;
    }

    #roomStats b {
      color: var(--name);
      font-weight: 700;
    }

    .main {
      display: flex;
      height: calc(100% - 110px);
      gap: 1px;
      background: var(--border);
      overflow: hidden;
      margin: 0 0 10px 0;
    }

    .panel {
      background: var(--card);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* T·ª∑ l·ªá c·ªôt: 34% - 28% - 18.9% - 18.9% */
    .panel:nth-child(1) {
      flex: 0 0 34%;
    }

    /* CHAT */
    .panel:nth-child(2) {
      flex: 0 0 28%;
    }

    /* Y√äU C·∫¶U */
    .panel:nth-child(3) {
      flex: 0 0 18.9%;
    }

    /* GIFTS */
    .panel:nth-child(4) {
      flex: 0 0 18.9%;
    }
    
    /* ACTIONS */
    .panel h3 {
      margin: 0;
      padding: 5px;
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.5px;
      background: var(--header-bg);
      border-bottom: 2px solid var(--border);
      text-transform: uppercase;
    }

    .chatListContainer {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      scroll-behavior: smooth;
    }

    .chatListContainer::-webkit-scrollbar {
      width: 8px;
    }

    .chatListContainer::-webkit-scrollbar-track {
      background: var(--card);
    }

    .chatListContainer::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .chatListContainer::-webkit-scrollbar-thumb:hover {
      background: var(--uid);
    }

    .msg {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 5px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .msg:hover {
      background: var(--hover);
      box-shadow: 0 2px 6px var(--shadow);
      transform: translateX(2px);
    }

    .msg.selected {
      background: rgba(255, 152, 0, 0.15);
      border-color: var(--orange);
      box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.3);
    }

    .msg.temporary {
      opacity: 0.6;
      font-style: italic;
    }

    .chat-head {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 2px;
      flex-wrap: wrap;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      box-shadow: 0 2px 4px var(--shadow);
    }

    .time {
      font-size: 11px;
      opacity: 0.7;
      background: var(--hover);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .name {
      color: var(--name);
      font-weight: 600;
      font-size: 14px;
    }

    .uid {
      font-size: 12px;
      color: var(--uid);
      opacity: 0.8;
    }

    .arrow {
      margin-left: auto;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.3s;
      padding: 6px 8px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .arrow:hover {
      opacity: 1;
      background: var(--hover);
      transform: scale(1.15);
    }

    .arrow svg {
      width: 18px;
      height: 18px;
      fill: var(--orange);
    }

    #chat .msg>div:last-child {
      padding-left: 40px;
      line-height: 1.5;
      color: var(--fg);
    }

    .req {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      position: relative;
      padding: 8px 10px;
      padding-right: 80px;
      margin-bottom: 10px;
      background: var(--card);
      border: 1px solid #f93740;
      border-radius: 8px;
      line-height: 1.6;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px var(--shadow);
      color: var(--fg);
    }

    .req:hover {
      background: var(--hover);
      box-shadow: 0 2px 6px var(--shadow);
    }

    .req .req-nickname {
      color: var(--name);
      font-weight: 600;
      font-size: 14px;
      transition: color 0.3s ease;
    }

    .req .req-message {
      color: #f50e0e;
      transition: color 0.3s ease;
    }

    /* Khi ƒë∆∞·ª£c check - TO√ÄN B·ªò ƒë·ªïi m√†u xanh */
    .req.done {
      border-color: #10b981;
    }

    .req.done .req-nickname {
      color: var(--name);
    }

    .req.done .req-message {
      color: #10b981;
    }

    .req .checkbox-icon {
      position: absolute;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.3s;
      opacity: 0.7;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .req .checkbox-icon:hover {
      opacity: 1;
      background: var(--hover);
    }

    .req .checkbox-icon svg {
      width: 20px;
      height: 20px;
      fill: #ef4444;
      transition: fill 0.3s ease;
    }

    .req.done .checkbox-icon svg {
      fill: #10b981;
    }

    .req .del {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none !important;
      border: none !important;
      cursor: pointer;
      padding: 6px !important;
      border-radius: 4px;
      transition: all 0.3s;
      opacity: 0.6;
      box-shadow: none !important;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .req .del:hover {
      opacity: 1;
      background: rgba(244, 67, 54, 0.15) !important;
      transform: translateY(-50%) scale(1.2);
    }

    .req .del svg {
      width: 16px;
      height: 16px;
      fill: #f44336;
    }

    .gift-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px;
      margin-bottom: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px var(--shadow);
    }

    .gift-item:hover {
      background: var(--hover);
      box-shadow: 0 2px 6px var(--shadow);
      transform: translateX(2px);
    }

    .gift-item .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
    }

    .gift-details {
      flex: 1;
    }

    .gift-sender {
      color: var(--name);
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .gift-desc {
      font-size: 12px;
      color: var(--uid);
      margin-bottom: 8px;
    }

    .gift-info-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .gift-icon {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      border: 2px solid var(--border);
      background: var(--hover);
    }

    .gift-stats {
      flex: 1;
      font-size: 12px;
      line-height: 1.6;
    }

    .gift-stats b {
      color: var(--name);
    }

    .gift-repeat-pending {
      color: #ef4444;
      font-weight: 700;
    }

    /* Action item styling for member join, likes, shares */
    .action-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      margin-bottom: 6px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px var(--shadow);
      font-size: 13px;
    }

    .action-item:hover {
      background: var(--hover);
      box-shadow: 0 2px 6px var(--shadow);
    }

    .action-item.temporary {
      opacity: 0.6;
      font-style: italic;
    }

    .action-item .avatar {
      width: 28px;
      height: 28px;
    }

    .action-content {
      flex: 1;
      line-height: 1.4;
    }

    .action-username {
      color: var(--name);
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .main {
        flex-direction: column;
      }

      .panel:nth-child(1),
      .panel:nth-child(2),
      .panel:nth-child(3),
      .panel:nth-child(4) {
        flex: 1 1 auto;
      }

      header {
        padding: 12px;
      }

      #username {
        min-width: 100%;
      }

      label {
        font-size: 12px;
      }
    }
  </style>
  <style>
    @view-transition {
      navigation: auto;
    }
  </style>

</head>

<body>
  <header><input id="username" placeholder="TikTok username">
    <button id="connect">Connect</button>
    <button id="copyAll">Copy</button>
    <button id="clear">Clear</button>
    <label> <input type="checkbox" id="showId"> <span>Hi·ªán ID</span> </label>
    <label> <input type="checkbox" id="hideTime"> <span>Hi·ªán th·ªùi gian</span> </label>
    <label><input type="checkbox" id="theme"> Light</label>

    <span id="currentLive"></span>
  </header>
  <div class="state-info">
    <div class="state-section">
      <pre id="stateText">Disconnected</pre>
    </div>
    <div class="state-section">
      <div id="roomStats">
        Ch·ªù k·∫øt n·ªëi...
      </div>
    </div>
  </div>
  <main class="main">
    <!-- Column 1: CHAT (34%) - Ch·ªâ ch·ª©a tin nh·∫Øn chat thu·∫ßn t√∫y -->
    <div class="panel">
      <h3>CHAT</h3>
      <div class="chatListContainer">
        <div id="chat"></div>
      </div>
    </div><!-- Column 2: Y√äU C·∫¶U (28%) - Danh s√°ch c√°c y√™u c·∫ßu ƒë∆∞·ª£c pin -->
    <div class="panel">
      <h3>Y√äU C·∫¶U</h3>
      <div class="chatListContainer">
        <div id="request"></div>
      </div>
    </div><!-- Column 3: GIFTS (18.9%) - Danh s√°ch qu√† t·∫∑ng -->
    <div class="panel">
      <h3>GIFTS</h3>
      <div class="chatListContainer">
        <div id="gifts"></div>
      </div>
    </div><!-- Column 4: ACTIONS (18.9%) - Member join, likes, shares -->
    <div class="panel">
      <h3>ACTIONS</h3>
      <div class="chatListContainer">
        <div id="actions"></div>
      </div>
    </div>
  </main><!-- Socket.IO Client Library -->

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==========================================
    // FILE: connection.js
    // M√¥ t·∫£: Wrapper for TikTok connection over Socket.IO with reconnect functionality
    // ==========================================
    /**
     * TikTokIOConnection Class
     * Qu·∫£n l√Ω k·∫øt n·ªëi Socket.IO v·ªõi TikTok Live backend
     * H·ªó tr·ª£ t·ª± ƒë·ªông reconnect khi m·∫•t k·∫øt n·ªëi
     */
    class TikTokIOConnection {
      constructor(backendUrl) {
        this.socket = io(backendUrl);
        this.uniqueId = null;
        this.options = null;
        // Event: Khi socket k·∫øt n·ªëi th√†nh c√¥ng
        this.socket.on('connect', () => {
          console.info("Socket connected!");
          // Reconnect to streamer if uniqueId already set
          // T·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i v·ªõi streamer n·∫øu ƒë√£ c√≥ uniqueId
          if (this.uniqueId) {
            this.setUniqueId();
          }
        });
        // Event: Khi socket b·ªã ng·∫Øt k·∫øt n·ªëi
        this.socket.on('disconnect', () => {
          console.warn("Socket disconnected!");
        });
        // Event: Khi livestream k·∫øt th√∫c
        this.socket.on('streamEnd', () => {
          console.warn("LIVE has ended!");
          this.uniqueId = null;
        });
        // Event: Khi TikTok b·ªã ng·∫Øt k·∫øt n·ªëi
        this.socket.on('tiktokDisconnected', (errMsg) => {
          console.warn(errMsg);
          if (errMsg && errMsg.includes('LIVE has ended')) {
            this.uniqueId = null;
          }
        });
      }
      /**
       * K·∫øt n·ªëi t·ªõi TikTok Live c·ªßa m·ªôt user
       * @param {string} uniqueId - TikTok username
       * @param {object} options - C√°c t√πy ch·ªçn k·∫øt n·ªëi (enableExtendedGiftInfo, etc.)
       * @returns {Promise} - Resolve khi k·∫øt n·ªëi th√†nh c√¥ng, Reject khi th·∫•t b·∫°i
       */
      connect(uniqueId, options) {
        this.uniqueId = uniqueId;
        this.options = options || {};
        this.setUniqueId();
        return new Promise((resolve, reject) => {
          this.socket.once('tiktokConnected', resolve);
          this.socket.once('tiktokDisconnected', reject);
          // Timeout sau 15 gi√¢y n·∫øu kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c
          setTimeout(() => {
            reject('Connection Timeout');
          }, 15000);
        });
      }
      /**
       * G·ª≠i uniqueId t·ªõi backend ƒë·ªÉ b·∫Øt ƒë·∫ßu k·∫øt n·ªëi TikTok Live
       */
      setUniqueId() {
        this.socket.emit('setUniqueId', this.uniqueId, this.options);
      }
      /**
       * ƒêƒÉng k√Ω event listener cho c√°c s·ª± ki·ªán TikTok Live
       * @param {string} eventName - T√™n event (chat, gift, member, like, etc.)
       * @param {function} eventHandler - H√†m x·ª≠ l√Ω khi event ƒë∆∞·ª£c trigger
       */
      on(eventName, eventHandler) {
        this.socket.on(eventName, eventHandler);
      }
    }
    // ==========================================
    // END FILE: connection.js
    // ==========================================
    // ==========================================
    
    // FILE: app.js
    // M√¥ t·∫£: Main application logic for TikTok Live Chat Monitor
    // ==========================================
    // -------- CONFIGURATION (app.js) --------
    /**
     * MAX_MESSAGES: S·ªë l∆∞·ª£ng tin nh·∫Øn t·ªëi ƒëa cho m·ªói container
     * - N·∫øu = 0: L∆∞u to√†n b·ªô tin nh·∫Øn (kh√¥ng gi·ªõi h·∫°n)
     * - N·∫øu > 0: Khi v∆∞·ª£t qu√° gi·ªõi h·∫°n, s·∫Ω x√≥a 200 tin c≈© nh·∫•t ƒë·ªÉ t·ªëi ∆∞u hi·ªáu nƒÉng
     * √Åp d·ª•ng cho: Chat, Actions
     */
    // const MAX_MESSAGES = 0; // ƒê·ªïi th√†nh 0 ƒë·ªÉ l∆∞u to√†n b·ªô tin nh·∫Øn
    /**
     * MAX_GIFTS: S·ªë l∆∞·ª£ng gift t·ªëi ƒëa
     * - N·∫øu = 0: L∆∞u to√†n b·ªô gifts
     * - N·∫øu > 0: Khi v∆∞·ª£t qu√°, x√≥a 100 gifts c≈© nh·∫•t
     */
    // const MAX_GIFTS = 0; // ƒê·ªïi th√†nh 0 ƒë·ªÉ l∆∞u to√†n b·ªô gifts

    /**
     * MAX: S·ªë l∆∞·ª£ng tin nh·∫Øn t·ªëi ƒëa cho m·ªói container
     * - N·∫øu = 0: L∆∞u to√†n b·ªô tin nh·∫Øn (kh√¥ng gi·ªõi h·∫°n)
     * - N·∫øu > 0: Khi v∆∞·ª£t qu√° gi·ªõi h·∫°n, s·∫Ω x√≥a BATCH = ? tin c≈© nh·∫•t ƒë·ªÉ t·ªëi ∆∞u hi·ªáu nƒÉng
     * BATCH: S·ªë l∆∞·ª£ng tin nh·∫Øn c·∫ßn x√≥a
     * √Åp d·ª•ng cho: Chat, Gift, Actions
     */    
    const UI_CONFIG = {
    CHAT:    { MAX: 0,   
              BATCH: 100 
             },
    GIFTS:   { MAX: 0,   
              BATCH: 100 
             },
    ACTIONS: { MAX: 5000, 
              BATCH: 1000 
             } // M·ª•c ti√™u 10k d√≤ng cho Like/Share/Join
      };
    
    // -------- KHAI B√ÅO C√ÅC PH·∫¶N T·ª¨ GIAO DI·ªÜN (DOM ELEMENTS) (app.js) --------
    const chatDiv = document.getElementById('chat');
    const reqDiv = document.getElementById('request');
    const giftsDiv = document.getElementById('gifts');
    const actionsDiv = document.getElementById('actions');
    const chatContainers = document.querySelectorAll('.chatListContainer');
    const currentLiveDiv = document.getElementById('currentLive'); // Th√¥ng tin streamer
    const stateText = document.getElementById('stateText'); // Th√¥ng b√°o tr·∫°ng th√°i k·∫øt n·ªëi
    const usernameInput = document.getElementById('username'); // √î nh·∫≠p username
    
    // -------- STATE VARIABLES (app.js) --------
    let autoScroll = true; // T·ª± ƒë·ªông scroll xu·ªëng cu·ªëi khi c√≥ tin m·ªõi
    let showIdEnabled = false; // Hi·ªÉn th·ªã User ID
    let showTimeEnabled = false; // Hi·ªÉn th·ªã th·ªùi gian
    
    // TikTok Connection (s·ª≠ d·ª•ng connection.js)
    // Backend URL: s·ª≠ d·ª•ng server proxy n·∫øu ch·∫°y t·ª´ file://, ng∆∞·ª£c l·∫°i d√πng c√πng domain
    let backendUrl = location.protocol === 'file:' ? "https://tiktok-chat-reader.zerody.one/" : undefined;
    let connection = new TikTokIOConnection(backendUrl);
    
    // Room Statistics (from app.js window.settings)
    let viewerCount = 0; // S·ªë ng∆∞·ªùi xem hi·ªán t·∫°i
    let likeCount = 0; // T·ªïng s·ªë like
    let diamondsCount = 0; // T·ªïng s·ªë diamonds t·ª´ gifts
    
    // -------- SVG ICONS (app.js) --------
    const pinIcon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M16 12V4h1c.55 0 1-.45 1-1s-.45-1-1-1H7c-.55 0-1 .45-1 1s.45 1 1 1h1v8l-2 2v2h5v6l1 1 1-1v-6h5v-2l-2-2zm-2 0l-1 1-1-1V4h2v8z"/>
    </svg>`;
    const trashIcon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
    </svg>`;
    const checkboxUnchecked = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
    </svg>`;
    const checkboxChecked = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
    </svg>`;
    const moonIcon = `<svg class="theme-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
    </svg>`;
    const sunIcon = `<svg class="theme-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="5"/>
      <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
    </svg>`;

    function resetUI() {
      // D√πng tr·ª±c ti·∫øp c√°c bi·∫øn ƒë√£ khai b√°o ·ªü ƒë·∫ßu file
      chatDiv.innerHTML = '';
      reqDiv.innerHTML = '';
      giftsDiv.innerHTML = '';
      actionsDiv.innerHTML = '';
      currentLiveDiv.innerHTML = '';
      stateText.innerHTML = '';
      // Reset s·ªë li·ªáu
      viewerCount = 0;
      likeCount = 0;
      diamondsCount = 0;
      updateRoomStats();
      //console.log("üßπ ƒê√£ d·ªçn d·∫πp to√†n b·ªô d·ªØ li·ªáu phi√™n c≈©.");
    }

    
    // -------- UTILITY FUNCTIONS (app.js) --------
    /**
     * Sanitize text ƒë·ªÉ ngƒÉn ch·∫∑n XSS attacks
     * Chuy·ªÉn ƒë·ªïi < th√†nh &lt; ƒë·ªÉ hi·ªÉn th·ªã an to√†n
     */
    function sanitize(text) {
      return text.replace(/</g, '&lt;');
    }
    /**
     * L·∫•y th·ªùi gian hi·ªán t·∫°i theo ƒë·ªãnh d·∫°ng HH:MM:SS (Vi·ªát Nam)
     */
    function getCurrentTime() {
      const d = new Date();
      // T√≠nh GMT+7
      const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
      const tz = new Date(utc + 7 * 3600000);
      const yyyy = tz.getFullYear();
      const mm = String(tz.getMonth() + 1).padStart(2, '0');
      const dd = String(tz.getDate()).padStart(2, '0');
      const hh = String(tz.getHours()).padStart(2, '0');
      const min = String(tz.getMinutes()).padStart(2, '0');
      const ss = String(tz.getSeconds()).padStart(2, '0');
      return `${dd}-${mm}-${yyyy} ${hh}:${min}:${ss}`;
    }
    // console.log(fullTimestamp()); 
    // V√≠ d·ª•: "21-12-2025 21:37:08"
    /**
     * C·∫≠p nh·∫≠t th·ªëng k√™ ph√≤ng live (viewers, likes, diamonds)
     * Hi·ªÉn th·ªã tr√™n c√πng 1 row thay v√¨ column
     */
    function updateRoomStats() {
      document.getElementById('roomStats').innerHTML = `
        <div><strong>Viewers:</strong> <b>${viewerCount.toLocaleString()}</b></div>
        <div><strong>Likes:</strong> <b>${likeCount.toLocaleString()}</b></div>
        <div><strong>Diamonds:</strong> <b>${diamondsCount.toLocaleString()}</b></div>
      `;
    }
    
    /**
     * T·∫°o link username d·∫´n t·ªõi profile TikTok
     * @param {object} data - D·ªØ li·ªáu user ch·ª©a uniqueId
     * @returns {string} HTML anchor tag
     */
    function generateUsernameLink(data) {
      const id_user = data.uniqueId || data.display_id || "";
      const name_user = data.nickname || data.displayName || "User";
      return `<a class="usernamelink" href="https://www.tiktok.com/@${id_user}" target="_blank"
      rel="noopener noreferrer" style="color: var(--name); text-decoration: none;">${name_user}</a>`;
    }

    /**
     * Ki·ªÉm tra xem gift c√≥ ƒëang ch·ªù streak k·∫øt th√∫c kh√¥ng
     * @param {object} data - D·ªØ li·ªáu gift
     * @returns {boolean} true n·∫øu ƒëang pending streak
     */
    function isPendingStreak(data) {
      return data.giftType === 1 && !data.repeatEnd;
    }

    /**
     * X√≥a c√°c tin nh·∫µn c≈© ·ªü tr√™n ƒë·∫ßu
     */
    function checkAndCleanUI(container, config, direction = 'top') {
      if (config.MAX > 0 && container.children.length > config.MAX) {
        let toRemove = config.BATCH;
        while (toRemove > 0 && container.children.length > 0) {
          // X√≥a ph·∫ßn t·ª≠ c≈© nh·∫•t d·ª±a tr√™n h∆∞·ªõng th√™m v√†o
          const target = (direction === 'top') ? container.firstChild : container.lastChild;
          
          if (target) {
            container.removeChild(target);
          } else {
            break;
          }
          toRemove--;
        }
      }
    }

    // Khai b√°o bi·∫øn t·ª´ ƒëi·ªÉn qu√† t·∫∑ng to√†n c·ª•c
    let giftDictionaryMap = {};
    
    /**
    * T·∫£i t·ª´ ƒëi·ªÉn qu√† t·∫∑ng ti·∫øng Vi·ªát t·ª´ file JSON
    * ƒê·∫£m b·∫£o file vi-VN.json n·∫±m trong th∆∞ m·ª•c public
    */
    async function loadGiftDictionary() {
      try {
        // Fetch tr·ª±c ti·∫øp t·ª´ th∆∞ m·ª•c public
        const response = await fetch('./vi-VN.json');
        
        if (!response.ok) {
          throw new Error(`Kh√¥ng th·ªÉ t·∫£i file: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Ki·ªÉm tra xem d·ªØ li·ªáu c√≥ ph·∫£i l√† Object kh√¥ng tr∆∞·ªõc khi g√°n
        if (data && typeof data === 'object') {
          giftDictionaryMap = data;
          console.log("‚úÖ [Dictionary] ƒê√£ n·∫°p t·ª´ ƒëi·ªÉn qu√† t·∫∑ng ti·∫øng Vi·ªát th√†nh c√¥ng.");
        } else {
          console.warn("‚ö†Ô∏è [Dictionary] File JSON kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng Object.");
        }
      } catch (err) {
        console.error("‚ùå [Dictionary] L·ªói khi n·∫°p file vi-VN.json:", err);
      }
    }
    
    // G·ªçi h√†m n·∫°p t·ª´ ƒëi·ªÉn ngay khi kh·ªüi ƒë·ªông app
    loadGiftDictionary();
    
    // -------- AUTO SCROLL LOGIC (app.js) --------
    /**
     * Theo d√µi scroll position c·ªßa m·ªói container
     * N·∫øu user scroll l√™n xem l·∫°i, t·∫Øt auto-scroll
     * N·∫øu user scroll xu·ªëng cu·ªëi, b·∫≠t l·∫°i auto-scroll
     */
    chatContainers.forEach(container => {
      // Kh·ªüi t·∫°o tr·∫°ng th√°i m·∫∑c ƒë·ªãnh cho t·ª´ng container
      container._autoScrollEnabled = true;
      container.addEventListener('scroll', () => {
        // Ki·ªÉm tra xem ƒë√£ cu·ªôn xu·ªëng s√°t ƒë√°y ch∆∞a (sai s·ªë 10px)
        const atBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 10;
        // L∆∞u tr·∫°ng th√°i v√†o ch√≠nh container ƒë√≥
        container._autoScrollEnabled = atBottom;
      });
    });
    
    /**
     * Scroll container xu·ªëng cu·ªëi n·∫øu autoScroll ƒëang b·∫≠t
     * @param {HTMLElement} container - Container c·∫ßn scroll
     */
    function scrollIfNeeded(container) {
      // Ch·ªâ cu·ªôn n·∫øu thu·ªôc t√≠nh ri√™ng c·ªßa container n√†y l√† true
      if (container._autoScrollEnabled) {
        container.scrollTo({
          top: container.scrollHeight,
          behavior: 'smooth' // Gi√∫p cu·ªôn m∆∞·ª£t m√† h∆°n
        });
      }
    }

    
    // -------- BUTTON HANDLERS (app.js) --------
    /**
     * X√≥a to√†n b·ªô n·ªôi dung c·ªßa t·∫•t c·∫£ c√°c container
     */
    document.getElementById('clear').onclick = () => {
      chatDiv.innerHTML = '';
      reqDiv.innerHTML = '';
      giftsDiv.innerHTML = '';
      actionsDiv.innerHTML = '';
      currentLiveDiv.innerHTML = '';
      stateText.innerHTML = '';
      usernameInput.innerHTML = '';
    };
    
    /**
     * Copy to√†n b·ªô n·ªôi dung y√™u c·∫ßu v√†o clipboard
     */
    document.getElementById('copyAll').onclick = () => {
      const text = reqDiv.innerText;
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('copyAll');
        const originalText = btn.textContent;
        btn.textContent = 'ƒê√£ copy!';
        setTimeout(() => btn.textContent = originalText, 1500);
      });
    };

    
    // -------- TOGGLE VISIBILITY (app.js) --------
    /**
     * C·∫≠p nh·∫≠t hi·ªÉn th·ªã c·ªßa User ID v√† Time d·ª±a tr√™n checkbox
     */
    function updateElementsVisibility() {
      document.querySelectorAll('.uid').forEach(u => {
        u.style.display = showIdEnabled ? 'inline' : 'none';
      });
      document.querySelectorAll('.time').forEach(t => {
        t.style.display = showTimeEnabled ? 'inline' : 'none';
      });
    }
   
    /**
     * Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu c·ªßa c√°c checkbox
     */
    function setInitialDisplay() {
      const showIdCheckbox = document.getElementById('showId');
      const hideTimeCheckbox = document.getElementById('hideTime');
      showIdCheckbox.checked = false;
      hideTimeCheckbox.checked = false;
      showIdEnabled = false;
      showTimeEnabled = false;
      updateElementsVisibility();
      showIdCheckbox.onchange = (e) => {
        showIdEnabled = e.target.checked;
        updateElementsVisibility();
      };
      hideTimeCheckbox.onchange = (e) => {
        showTimeEnabled = e.target.checked;
        updateElementsVisibility();
      };
    }
    
    setInitialDisplay();
   
    
    // -------- THEME TOGGLE (app.js) --------
    // Light/Dark Mode
    const themeCheckbox = document.getElementById('theme');
    themeCheckbox.onchange = (e) => {
      document.documentElement.classList.toggle('light', e.target.checked);
    };
    
    
    // -------- RENDER CHAT FUNCTIONS (app.js) --------
    /**
     * Th√™m tin nh·∫Øn chat m·ªõi v√†o container CHAT
     * Ch·ªâ ch·ª©a tin nh·∫Øn thu·∫ßn t√∫y, kh√¥ng c√≥ actions
     * @param {object} data - D·ªØ li·ªáu user
     * @param {string} text - N·ªôi dung tin nh·∫Øn
     * @param {string} color - M√†u ch·ªØ (optional)
     */
    function renderChat(data, text, color = '') {      
      // DEBUG: Log d·ªØ li·ªáu ng∆∞·ªùi chat v√† n·ªôi dung tin nh·∫Øn, // Clone ƒë·ªÉ xem c·∫•u tr√∫c th·∫≠t
      // console.log("üí¨ CHAT DATA:", { user: JSON.parse(JSON.stringify(data)), rawText: text });
      
      checkAndCleanUI(chatDiv, UI_CONFIG.CHAT, 'top');
      
      /**if (MAX_MESSAGES > 0 && chatDiv.children.length > MAX_MESSAGES) {
        Array.from(chatDiv.children).slice(0, 200).forEach(el => el.remove());
      }*/
      
      const div = document.createElement('div');
      div.className = 'msg';
      const msgData = {
        avatar: data.profilePictureUrl || `https://ui-avatars.com/api/?name=${data.uniqueId.charAt(0).toUpperCase()}&background=4fc3f7&color=fff&size=128`,
        time: getCurrentTime(),
        nickname: data.nickname || data.displayName || data.uniqueId,
        userId: data.uniqueId || data.userId,
        message: sanitize(text)
      };
      div.innerHTML = `
        <div class="chat-head">
          <img class="avatar" src="${msgData.avatar}" alt="${msgData.nickname}">
          <span class="time" style="display: ${showTimeEnabled ? 'inline' : 'none'}">[${msgData.time}]</span>
          <span class="name">${generateUsernameLink(data)}</span>
          <span class="uid" style="display: ${showIdEnabled ? 'inline' : 'none'}">@${msgData.userId}</span>
          <span class="arrow">${pinIcon}</span>
        </div>
        <div style="${color ? 'color:' + color : ''}">${msgData.message}</div>
      `;
      // Click v√†o icon pin ƒë·ªÉ th√™m v√†o danh s√°ch y√™u c·∫ßu
      // div.querySelector('.arrow').onclick = () => addRequest(msgData, div);
      // Truy·ªÅn c·∫£ d·ªØ li·ªáu g·ªëc (data) v√† n·ªôi dung tin nh·∫Øn (text)
      div.querySelector('.arrow').onclick = () => addRequest(data, text, div);
      chatDiv.appendChild(div);
      scrollIfNeeded(chatDiv.parentElement);
    }
    
    // -------- ADD REQUEST FUNCTION (app.js) --------
    /**
     * Th√™m tin nh·∫Øn v√†o danh s√°ch y√™u c·∫ßu (pin message)
     * @param {object} msg - D·ªØ li·ªáu tin nh·∫Øn
     * @param {HTMLElement} chatEl - Element tin nh·∫Øn g·ªëc ƒë·ªÉ ƒë√°nh d·∫•u ƒë√£ pin
     */
    //function addRequest(msg, chatEl) {
    function addRequest(data, text, chatEl) {
      // DEBUG: Log d·ªØ li·ªáu tin nh·∫Øn khi ƒë∆∞·ª£c ƒë∆∞a v√†o danh s√°ch y√™u c·∫ßu
      // console.log("üìå PINNED REQUEST:", JSON.stringify(msg, null, 2));
      chatEl.classList.add('selected');
      const d = document.createElement('div');
      d.className = 'req';
      d.innerHTML = `
        <div>         
          <span class="req-nickname">${generateUsernameLink(data)}</span>: 
          <span class="req-message">${sanitize(text)}</span>
        </div>
        <span class="checkbox-icon">${checkboxUnchecked}</span>
        <button class="del">${trashIcon}</button>
      `;
      const checkboxIcon = d.querySelector('.checkbox-icon');
      let isChecked = false;
      // Toggle tr·∫°ng th√°i ho√†n th√†nh (done/undone)
      checkboxIcon.onclick = () => {
        isChecked = !isChecked;
        checkboxIcon.innerHTML = isChecked ? checkboxChecked : checkboxUnchecked;
        d.classList.toggle('done', isChecked);
      };
      // X√≥a y√™u c·∫ßu
      d.querySelector('.del').onclick = () => d.remove();
      reqDiv.appendChild(d);
      scrollIfNeeded(reqDiv.parentElement);
    }
    
    // -------- RENDER GIFT FUNCTION (app.js) --------
    /**
     * Th√™m gift m·ªõi v√†o container GIFTS
     * H·ªó tr·ª£ update gift streak (combo) theo real-time
     * @param {object} data - D·ªØ li·ªáu gift
     */
    function renderGift(data) {
      // DEBUG: Log d·ªØ li·ªáu Gift (T√™n qu√†, ID qu√†, Diamond, Combo)
      // console.log("üéÅ GIFT RECEIVED:", JSON.stringify(data, null, 2));

      // Tra c·ª©u t√™n ti·∫øng Vi·ªát t·ª´ t·ª´ ƒëi·ªÉn d·ª±a tr√™n giftId
      const giftKey = `live_gift_${data.giftId}`;
      const giftNameVN = giftDictionaryMap[giftKey]; // KH√îNG ƒë·ªÉ || data.giftName ·ªü ƒë√¢y ƒë·ªÉ logic d·ª± ph√≤ng ph√≠a d∆∞·ªõi ch·∫°y ƒë√∫ng
      
      checkAndCleanUI(giftsDiv, UI_CONFIG.GIFTS, 'top');
      
      /*if (MAX_GIFTS > 0 && giftsDiv.children.length > MAX_GIFTS) {
        Array.from(giftsDiv.children).slice(0, 100).forEach(el => el.remove());
      }*/
      
      // T·∫°o unique ID cho streak (userId + giftId)
      const streakId = data.userId.toString() + '_' + data.giftId;
      const existingStreak = giftsDiv.querySelector(`[data-streakid="${streakId}"]`);
      const div = document.createElement('div');
      div.className = 'gift-item';
      
      // N·∫øu gift ƒëang pending streak, g·∫Øn data attribute ƒë·ªÉ update sau
      if (isPendingStreak(data)) {
        div.setAttribute('data-streakid', streakId);
      }

      /*
      div.innerHTML = `
        <img class="avatar" src="${data.profilePictureUrl}" alt="${data.uniqueId}">
        <div class="gift-details">
          <div class="gift-sender">${generateUsernameLink(data)}</div>
          <div class="gift-desc">${sanitize(data.describe || '')}</div>
          <div class="gift-info-row">
            <img class="gift-icon" src="${data.giftPictureUrl}" alt="${data.giftName}">
            <div class="gift-stats">
              <div>Name: <b>${sanitize(data.giftName)}</b> (ID: ${data.giftId})</div>
              <div>Repeat: <b style="${isPendingStreak(data) ? 'color:red' : ''}">x${data.repeatCount.toLocaleString()}</b></div>
              <div>Cost: <b>${(data.diamondCount * data.repeatCount).toLocaleString()} Diamonds</b></div>
            </div>
          </div>
        </div>
      `;
      */

      // N·∫øu c√≥ giftNameVN th√¨ hi·ªán "ƒë√£ g·ª≠i + t√™n", n·∫øu kh√¥ng c√≥ th√¨ hi·ªán describe g·ªëc
      const displayDesc = giftNameVN ? `ƒë√£ g·ª≠i ${giftNameVN}` : (data.describe || 'ƒë√£ g·ª≠i qu√†');
      
      div.innerHTML = `
        <img class="avatar" src="${data.profilePictureUrl}" alt="${data.uniqueId}">
        <div class="gift-details">
          <div class="gift-sender">${generateUsernameLink(data)}</div>
          <div class="gift-desc">${sanitize(displayDesc)}</div>
          <div class="gift-info-row">
            <img class="gift-icon" src="${data.giftPictureUrl}" alt="${giftNameVN}">
            <div class="gift-stats">
              <div>Name: <b>${sanitize(giftNameVN)}</b> (ID: ${data.giftId})</div>
              <div>Repeat: <b style="${isPendingStreak(data) ? 'color:red' : ''}">x${data.repeatCount.toLocaleString()}</b></div>
              <div>Cost: <b>${(data.diamondCount * data.repeatCount).toLocaleString()} Diamonds</b></div>
            </div>
          </div>
        </div>
      `;
      
      // N·∫øu ƒë√£ c√≥ streak n√†y, replace ƒë·ªÉ update s·ªë l∆∞·ª£ng combo
      if (existingStreak) {
        existingStreak.replaceWith(div);
      } else {
        giftsDiv.appendChild(div);
      }
      scrollIfNeeded(giftsDiv.parentElement);
    }
    
    // -------- RENDER ACTION FUNCTION (app.js) --------
    /**
     * Th√™m action event (member join, likes, shares) v√†o container ACTIONS
     * @param {object} data - D·ªØ li·ªáu user
     * @param {string} text - N·ªôi dung action
     * @param {string} color - M√†u ch·ªØ
     * @param {boolean} isTemporary - ƒê√°nh d·∫•u l√† tin t·∫°m th·ªùi (s·∫Ω b·ªã x√≥a khi c√≥ tin m·ªõi)
     * M√†u s·∫Øc ƒë·ªÅ xu·∫•t: Like (#447dd4), Join (#f39c12), Follow (#ff005e)   
     */
    function renderAction(data, text, color = '', isTemporary = false) {
      // DEBUG: Log c√°c h√†nh ƒë·ªông h·ªá th·ªëng
      // console.log("‚ö° ACTION EVENT:", { type: text, user: JSON.parse(JSON.stringify(data)), temp: isTemporary });

      checkAndCleanUI(actionsDiv, UI_CONFIG.ACTIONS, 'top');
      
      /* if (MAX_MESSAGES > 0 && actionsDiv.children.length > MAX_MESSAGES) {
        Array.from(actionsDiv.children).slice(0, 200).forEach(el => el.remove());
      }*/
      
      /**
       * X√≥a c√°c tin nh·∫Øn t·∫°m th·ªùi (temporary) tr∆∞·ªõc khi th√™m tin m·ªõi
       * √Åp d·ª•ng cho member join ƒë·ªÉ tr√°nh spam
       
      if (!isTemporary) {
        document.querySelectorAll('#actions .temporary').forEach(el => el.remove());
      }
      */
      
      const div = document.createElement('div');
      div.className = isTemporary ? 'action-item temporary' : 'action-item';
      const avatar = data.profilePictureUrl || `https://ui-avatars.com/api/?name=${data.uniqueId.charAt(0).toUpperCase()}&background=4fc3f7&color=fff&size=128`;
      div.innerHTML = `
        <img class="avatar" src="${avatar}" alt="${data.uniqueId}">
        <div class="action-content">
          <span class="action-username">${generateUsernameLink(data)}</span>:
          <span style="${color ? 'color:' + color : ''}">${sanitize(text)}</span>
        </div>
      `;

      // Th√™m v√†o danh s√°ch (Tin m·ªõi ·ªü d∆∞·ªõi c√πng)
      actionsDiv.appendChild(div);
      scrollIfNeeded(actionsDiv.parentElement);

      // X·ª≠ l√Ω x√≥a t·ª± ƒë·ªông cho tin Join
      if (isTemporary) {
        // Hi·ªáu ·ª©ng m·ªù d·∫ßn m∆∞·ª£t m√†
        div.style.transition = 'opacity 1s ease'; 
        div.style.opacity = '1';
        
        setTimeout(() => {
          if (div.parentNode) {
            div.style.opacity = '0'; // M·ªù d·∫ßn trong 1s
            
            setTimeout(() => {
              if (div.parentNode) div.remove(); // X√≥a h·∫≥n kh·ªèi RAM
            }, 1000); 
          }
        }, 6000); // 6 gi√¢y ƒë·ª©ng y√™n
      }
    }
    
    // -------- CONNECTION FUNCTION (app.js) --------
    /**
     * K·∫øt n·ªëi t·ªõi TikTok Live c·ªßa username ƒë∆∞·ª£c nh·∫≠p
     * T∆∞∆°ng t·ª± function connect() trong app.js g·ªëc
     */
    function connect() {
      const uniqueId = document.getElementById('username').value.trim();
      if (uniqueId === '') {
        document.getElementById('stateText').textContent = 'Vui l√≤ng nh·∫≠p username!';
        return;
      }
      // Reset UI
      resetUI();
      document.getElementById('stateText').textContent = 'ƒêang k·∫øt n·ªëi...';
      // K·∫øt n·ªëi v·ªõi enableExtendedGiftInfo ƒë·ªÉ l·∫•y th√¥ng tin gift ƒë·∫ßy ƒë·ªß
      connection.connect(uniqueId, {
        enableExtendedGiftInfo: true
      }).then(state => {
        // K·∫øt n·ªëi th√†nh c√¥ng
        document.getElementById('stateText').textContent = `Connected to roomId: ${state.roomId}`;
        // L·∫•y th√¥ng tin Streamer t·ª´ 'state' thay v√¨ ƒë·ª£i s·ª± ki·ªán roomUser
        if (state.roomInfo && state.roomInfo.owner) {
          renderStreamerInfo(state.roomInfo.owner);
        } else {
          // Backup n·∫øu SDK tr·∫£ v·ªÅ c·∫•u tr√∫c ph·∫≥ng
          renderStreamerInfo(state);
        }
        // Reset statistics khi k·∫øt n·ªëi m·ªõi
        viewerCount = 0;
        likeCount = 0;
        diamondsCount = 0;
        updateRoomStats();
      }).catch(errorMessage => {
        // K·∫øt n·ªëi th·∫•t b·∫°i
        document.getElementById('stateText').textContent = errorMessage;
        /**
         * TODO: Th√™m logic reconnect t·ª± ƒë·ªông n·∫øu c·∫ßn (t·ª´ app.js g·ªëc)
         * V√≠ d·ª•: N·∫øu c√≥ window.settings.username, t·ª± ƒë·ªông retry sau 30s
         * 
         * if (window.settings && window.settings.username) {
         *   setTimeout(() => {
         *     connect();
         *   }, 30000);
         * }
         */
      });
    }
    
    // H√†m hi·ªÉn th·ªã th√¥ng tin streamer
    /**
     * Hi·ªÉn th·ªã th√¥ng tin streamer hi·ªán t·∫°i
     * @param {object} data - D·ªØ li·ªáu streamer
     * data ch·ª©a: uniqueId, nickname, profilePictureUrl
     */
    function renderStreamerInfo(data) {
      // if (!data || (!data.nickname && !data.uniqueId)) return;
      // console.log("D·ªÆ LI·ªÜU STREAMER:", JSON.stringify(data, null, 2));
      if (!data) return;
      const displayName = data.nickname || data.displayName || 'Unknown';
      const username = data.display_id || data.uniqueId || '';
      let avatarUrl = ""
      // Ki·ªÉm tra: h·ªôp avatar_large t·ªìn t·∫°i -> c√≥ danh s√°ch url_list -> danh s√°ch kh√¥ng r·ªóng
      if (data.avatar_large && data.avatar_large.url_list && data.avatar_large.url_list.length > 0) {
        // L·∫•y link ƒê·∫¶U TI√äN (index 0)
        avatarUrl = data.avatar_large.url_list[0];
      }
      // T·∫°o Avatar n·∫øu username tr·ªëng, ui-avatars s·∫Ω d√πng name
      const avatar = avatarUrl || `https://ui-avatars.com/api/?name=${data.uniqueId}&background=2196f3&color=fff&size=128`;
      document.getElementById('currentLive').innerHTML = `
        <b style="color: var(--fg)">Live: </b>
        <img src="${avatar}" style="width:28px;height:28px;border-radius:50%;margin:0 6px;vertical-align:middle">
        <b>${generateUsernameLink(data)}</b>
        <span style="color:#888;margin-left:4px">@${username}</span>
      `;
    }
    
    // -------- EVENT LISTENERS (app.js) --------
    // Click button Connect
    document.getElementById('connect').onclick = connect;
    // Nh·∫•n Enter trong input username ƒë·ªÉ connect
    document.getElementById('username').addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        connect();
      }
    });
    
    // -------- TIKTOK LIVE EVENTS (app.js) --------
    /**
     * Event: roomUser
     * C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ng∆∞·ªùi xem trong ph√≤ng
     */
    connection.on('roomUser', (msg) => {
      if (typeof msg.viewerCount === 'number') {
        viewerCount = msg.viewerCount;
        updateRoomStats();
      }
      // Ch·ªâ c·∫≠p nh·∫≠t info n·∫øu trong msg c√≥ ch·ª©a object owner (ch·ªß ph√≤ng)
      // ƒêi·ªÅu n√†y lo·∫°i b·ªè ho√†n to√†n vi·ªác l·∫•y nh·∫ßm avatar c·ªßa ng∆∞·ªùi xem (viewer)
      // (M·ªôt s·ªë b·∫£n SDK tr·∫£ v·ªÅ th√¥ng tin ch·ªß ph√≤ng trong roomUser.owner)
      if (msg.owner) {
        renderStreamerInfo(msg.owner);
      }
    });
    
    /**
     * Event: member
     * Hi·ªÉn th·ªã khi c√≥ ng∆∞·ªùi join v√†o live
     * S·ª≠ d·ª•ng delay ƒë·ªÉ tr√°nh spam khi c√≥ nhi·ªÅu ng∆∞·ªùi join c√πng l√∫c
     */
    let joinMsgDelay = 0;
    connection.on('member', (msg) => {
      let addDelay = 250;
      if (joinMsgDelay > 500) addDelay = 100;
      if (joinMsgDelay > 1000) addDelay = 0;
      joinMsgDelay += addDelay;
      setTimeout(() => {
        joinMsgDelay -= addDelay;
        // renderAction(msg, 'joined', '#21b2c2', true); // temporary = true
        renderAction(msg, 'joined', '#f39c12', true); // temporary = true
      }, joinMsgDelay);
    });
    
    /**
     * Event: chat
     * Tin nh·∫Øn chat m·ªõi t·ª´ viewers
     * CH·ªà hi·ªÉn th·ªã trong c·ªôt CHAT
     */
    connection.on('chat', (msg) => {
      renderChat(msg, msg.comment);
    });
    
    /**
     * Event: gift
     * Qu√† t·∫∑ng m·ªõi t·ª´ viewers
     * C·∫≠p nh·∫≠t t·ªïng diamonds v√† hi·ªÉn th·ªã trong c·ªôt GIFTS
     */
    connection.on('gift', (data) => {
      // Ch·ªâ c·ªông diamonds khi gift streak k·∫øt th√∫c (kh√¥ng c√≤n pending)
      if (!isPendingStreak(data) && data.diamondCount > 0) {
        diamondsCount += (data.diamondCount * data.repeatCount);
        updateRoomStats();
      }
      renderGift(data);
    });
    
    /**
     * Event: like
     * C·∫≠p nh·∫≠t t·ªïng s·ªë like v√† hi·ªÉn th·ªã action trong ACTIONS column
     */
    connection.on('like', (msg) => {
      if (typeof msg.totalLikeCount === 'number') {
        likeCount = msg.totalLikeCount;
        updateRoomStats();
      }
      // Hi·ªÉn th·ªã like action trong c·ªôt ACTIONS
      if (typeof msg.likeCount === 'number') {
        // renderAction(msg, msg.label.replace('{0:user}', '').replace('likes', `${msg.likeCount} likes`), '#447dd4');
        // renderAction(msg, `liked the LIVE x${msg.likeCount}`, '#447dd4');
        // renderAction(msg, `‚ù§Ô∏è x${msg.likeCount}`, '#ff4b5c', 'action');
        renderAction(msg, `ƒë√£ ‚ù§Ô∏è x${msg.likeCount}`, '#447dd4');
      }
    });
    
    /**
     * Event: social
     * Share v√† Follow actions
     * Hi·ªÉn th·ªã trong c·ªôt ACTIONS v·ªõi m√†u kh√°c nhau
     */
    connection.on('social', (data) => {
      let color = data.displayType.includes('follow') ? '#ff005e' : '#2fb816';
      renderAction(data, data.label.replace('{0:user}', ''), color);
    });
    
    /**
     * Event: streamEnd
     * Livestream ƒë√£ k·∫øt th√∫c
     */
    connection.on('streamEnd', () => {
      document.getElementById('stateText').textContent = 'Stream ended.';
    });
    // -------- INITIALIZATION (app.js) --------
    // Kh·ªüi t·∫°o room stats ban ƒë·∫ßu
    updateRoomStats();
    // ==========================================
    // END FILE: app.js
    // ==========================================
  </script>
</body>

</html>
